<script>jwplayer.key="t4gfNe6B8Hwm15IrPRD2V1AMB+LODHvxPPqA5Q==";</script>
<div id="menubar">
	<p>
		<a href="/channels/main">Home</a>
		<% if session[:user_id] %>
			<a href="/users/<%= session[:user_id] %>">Profile</a>
		<% else %>
			<a href="/sessions/new">Profile</a>
		<% end %>
		<a href="#">FAQ</a>
		<a href="#">Blog</a>		
		<% if session[:user_id] %>
			<a class="logout" href="/logout">Logout</a>
		<% else %>
			<a class="logout" href="/sessions/new">Login</a>
		<% end %>
	</p>
</div>

<div id="stream">Loading the player ...</div>
<div id="chat">

		<% if session[:user_id] == @channel.user.id %>
			<ul id="comments">
				<% @comments.each do |comment| %>
					<li class ="comment clearfix" id='<%= comment.id %>'>
						<%= image_tag comment.user.avatar.url(:thumb), :class => 'image'%>
						<div class='text'>
							<% if comment.user.id == @channel.user.id %>
								<a href="/users/<%= comment.user.id %>" style='color: #ff60be;'><%= comment.user.username %></a>
							<% else %>
								<a href="/users/<%= comment.user.id %>"><%= comment.user.username %></a> 
							<% end %>
							<span style="color: silver;"><%= comment.created_at.strftime("%H:%M") %></span>
							<a href='' style='float:right;' class='delete'>X</a>
							<br><%= comment.body %>
						</div>
					</li>
				<% end %>
			</ul>
		<% else %>
			<ul id="comments">
				<% @comments.each do |comment| %>
					<li class ="comment clearfix" id='<%= comment.id %>'>
						<%= image_tag comment.user.avatar.url(:thumb), :class => 'image'%>
						<div class='text'>
							<% if comment.user.id == @channel.user.id %>
								<a href="/users/<%= comment.user.id %>" style='color: #ff60be;'><%= comment.user.username %></a>
							<% else %>
								<a href="/users/<%= comment.user.id %>"><%= comment.user.username %></a> 
							<% end %>
							<span style="color: silver;"><%= comment.created_at.strftime("%H:%M") %></span>
							<br><%= comment.body %>
						</div>
					</li>
				<% end %>
			</ul>
		<% end %>

	<div id="new_message">
		<% if session[:user_id] %>	
			<form>
				<textarea id='new_comment' placeholder='your comment...' name="body"></textarea>
				<input type="submit" name="Post" value="Post" class="post">
			</form>
		<% else %>
			<br><p style="font-weight: bold; text-align: center;">You must <a href="/sessions/new" style="color: #FF530D;">login</a> to leave a comment</p>
		<% end %>
	</div>
</div>

<div class="channel">
	<%= image_tag(@channel.logo.url(:thumb), :class => "image") %>
	<div class="text">
		<h3 class='white'><%= @channel.name %></h3>
		<p><%= @channel.description %></p>
		<p><%= @channel.user.username %></p>
	</div>
</div>

<script type="text/javascript">

		// make video size based on screen size
		// also adjust chat height while we're at it

	var fq = window.matchMedia( "(min-width: 2400px)" );
	var mq = window.matchMedia( "(min-width: 1720px)" );
	var lq = window.matchMedia( "(min-width: 1400px)" );
	
	if(fq.matches){
		var w = 1920;
		$('#chat').css("height","1080px");
		$('#comments').css("height","1010px");
	}else if(mq.matches){
		var w = 1280;
		$('#chat').css("height","720px");
		$('#comments').css("height","650px");
	}else if(lq.matches){
		var w = 960;
		$('#chat').css("height","540px");
		$('#comments').css("height","470px");
	}else{
		var w = 640;
		$('#chat').css("height","360px");
		$('#comments').css("height","290px");
	}

	// the jwplayer player

	var playerInstance = jwplayer("stream");

	playerInstance.setup({
		file: "rtmp://192.168.1.28:1935/live/flv:" + <%= @channel.secret.to_json.html_safe %>,
		width: w,
		height: w*9/16,
		primary: "flash",
		autostart: true,
		controls: true,
		stretching: "exactfit",
	}); 
</script>

<script>
$(document).ready(function(){

	var channel = <%= @channel.id.to_json.html_safe %>;
	var socket = io.connect('http://192.168.1.250:3001');

	function scrollChat(){
		var objDiv = document.getElementById("comments");
		objDiv.scrollTop = objDiv.scrollHeight;
	}
	scrollChat();

	$('.delete').click(function(){ 
		var del = {};
		var comment_id = $(this).parent().parent().attr('id');
 		del.comment = comment_id;
		del.user = <%= session[:user_id].to_json.html_safe %>
		console.log('attempt to delete', comment_id)
		$.post(`/comments/${comment_id}/delete`, del, function(data){
			if(data.response == "deleted"){
				socket.emit("delete_post", {channel: channel, comment_id: comment_id})
			}
		})
	})

	$('#new_message').submit(function(){
		var comment = $('#new_comment').serialize();
		$.post(`/channels/${channel}/comment`, comment, function(data){
			socket.emit("new_post", {channel: channel, comment: comment});
			$('#new_comment').val('');
			$('#comments').append(data);
			scrollChat();
		});
	return false;
	});

	socket.on('broadcast', function(data){
		if(data.response.channel == channel){
			$.get(`/channels/${channel}/comment`, function(data){
				$('#comments').append(data);
				scrollChat();
			})
		}
	})

	socket.on('delete', function(data){
		if(data.response.channel == channel){
			$(`#${data.response.comment_id}`).remove();
		}
	})

});
</script>