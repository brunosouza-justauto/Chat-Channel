<!-- I probably shouldn'y be pushing this thing... -->
<!-- is it even necessary for the player to work?... -->
<script>jwplayer.key="t4gfNe6B8Hwm15IrPRD2V1AMB+LODHvxPPqA5Q==";</script>

<!-- Menubar div -->
<div id="menubar">
	<p>
		<a href="/channels/main">Home</a>
		<% if session[:user_id] %>
			<a href="/users/<%= session[:user_id] %>">Profile</a>
		<% else %>
			<a href="/sessions/new">Profile</a>
		<% end %>
		<a href="#">FAQ</a>
		<a href="#">Blog</a>		
		<% if session[:user_id] %>
			<a class="logout" href="/logout">Logout</a>
		<% else %>
			<a class="logout" href="/sessions/new">Login</a>
		<% end %>
	</p>
</div>

<!-- The video player div -->
<div id="stream">
	Loading the player ...
</div>

<!-- The chat div -->
<div id="chat">
	<ul id="comments">
		<% @comments.each do |comment| %>
			<li class ="comment clearfix" id='<%= comment.id %>'>
				<%= image_tag comment.user.avatar.url(:thumb), :class => 'image'%>
				<div class='text'>
					<% if comment.user.id == @channel.user.id %>
						<a href="/users/<%= comment.user.id %>" style='color: #ff60be;'><%= comment.user.username %></a>
					<% else %>
						<a href="/users/<%= comment.user.id %>"><%= comment.user.username %></a> 
					<% end %>
					<!-- Move some of this styling into the css file -->
					<span style="color: silver;"><%= comment.created_at.strftime("%H:%M") %></span>
					<% if session[:user_id] == @channel.user.id %>
						<a href='' style='float:right;' class='delete'>X</a>
					<% end %>
					<br><%= comment.body %>
				</div>
			</li>
		<% end %>
	</ul>

	<div id="new_message">
		<% if session[:user_id] %>	
			<form>
				<textarea id='new_comment' placeholder='your comment...' name="body"></textarea>
				<input type="submit" name="Post" value="Post" class="post">
			</form>
		<% else %>
			<br><p style="font-weight: bold; text-align: center;">You must <a href="/sessions/new" style="color: #FF530D;">login</a> to leave a comment</p>
		<% end %>
	</div>

	<!-- Consider adding validation errors? -->
	<!-- No that's silly, you either post a comment or not -->
	<!-- It can tell a user they are banned or timed out maybe -->

</div>

<!-- Channel information... placeholder in need of styling -->
<div class="channel">
	<%= image_tag(@channel.logo.url(:thumb), :class => "image") %>
	<div class="text">
		<h3><%= @channel.name %></h3>
		<p><%= @channel.description %></p>
		<p><%= @channel.user.username %></p>
	</div>
</div>

<!-- Move this to an external js file! -->
<script type="text/javascript">

	// make video size based on screen size
	// also adjust chat height while we're at it

	// consider moving this stuff to css...

	var fq = window.matchMedia( "(min-width: 2400px)" );
	var mq = window.matchMedia( "(min-width: 1720px)" );
	var lq = window.matchMedia( "(min-width: 1400px)" );
	
	if(fq.matches){
		var w = 1920;
		$('#chat').css("height","1080px");
		$('#comments').css("height","1010px");
	}else if(mq.matches){
		var w = 1280;
		$('#chat').css("height","720px");
		$('#comments').css("height","650px");
	}else if(lq.matches){
		var w = 960;
		$('#chat').css("height","540px");
		$('#comments').css("height","470px");
	}else{
		var w = 640;
		$('#chat').css("height","360px");
		$('#comments').css("height","290px");
	}

	// the jwplayer player

	var playerInstance = jwplayer("stream");

	playerInstance.setup({
		file: "rtmp://192.168.1.28:1935/live/flv:" + <%= @channel.secret.to_json.html_safe %>,
		width: w,
		height: w*9/16,
		primary: "flash",
		autostart: true,
		controls: true,
		stretching: "exactfit",
	}); 

</script>

<!-- Move this to an external js file! -->
<script>

$(document).ready(function(){

	// some useful variables
	var channel = <%= @channel.id.to_json.html_safe %>;
	var socket = io.connect('http://192.168.1.250:3001');
	var user = <%= session[:user_id].to_json.html_safe %>;

	// the scroll chat gets called a few times so it's a good candidate to be a function
	function scrollChat(){
		var objDiv = document.getElementById("comments");
		objDiv.scrollTop = objDiv.scrollHeight;
	}
	scrollChat();

	// on loading the chat viewer emits to the server
	if(user){
		socket.emit("new_viewer", {channel: channel, viewer: user});
	}else{
		socket.emit("new_viewer", {channel: channel, viewer: 'unknown'});
	}

	// on page unload tell the sockets we're leaving!!!
	window.onbeforeunload =function(){
		if(user){
			socket.emit("leaving", {channel: channel, viewer: user});
		}else{
			socket.emit("leaving", {channel: channel, viewer: 'unknown'});
		}
	};

	// or if they click on a link that directs them somewhere else!
	$(document).on('click', 'a', function(){
		if(user){
			socket.emit("leaving", {channel: channel, viewer: user});
		}else{
			socket.emit("leaving", {channel: channel, viewer: 'unknown'});
		}
	})

	// submits a message to the chat
	$('#new_message').submit(function(){
		var comment = $('#new_comment').serialize();
		$.post(`/channels/${channel}/comment`, comment, function(data){
			socket.emit("new_post", {channel: channel, comment: comment});
			$('#new_comment').val('');
			$('#comments').append(data);
			scrollChat();
		});
	return false;
	});

	// allows channel owner to delete a comment
	$(document).on('click', '.delete', function(){
		var del = {};
		var comment_id = $(this).parent().parent().attr('id');
 		del.comment = comment_id;
		del.user = <%= session[:user_id].to_json.html_safe %>
		$.post(`/comments/${comment_id}/delete`, del, function(data){
			$(`#${comment_id}`).remove();
			if(data.response == "deleted"){
				socket.emit("delete_post", {channel: channel, comment_id: comment_id});
			}
		})
	})

	// fetches a comment from another user
	socket.on('broadcast', function(data){
		if(data.response.channel == channel){
			$.get(`/channels/${channel}/comment`, function(data){
				$('#comments').append(data);
				scrollChat();
			})
		}
	})

	// removes a comment deleted by channel owner
	socket.on('delete', function(data){
		if(data.response.channel == channel){
			$(`#${data.response.comment_id}`).remove();
		}
	})

});

</script>